from aiogram import types
from aiogram.dispatcher import FSMContext
from bot.bin.compatibility_db import compatibility_caption
from bot.filters import IsNotAdminUser
from bot.handlers.channels_op import check_subscribe_channels
from aiogram.dispatcher.filters.builtin import Text
from bot.keyboards import inline as ikb
from bot.loader import bot, dp
from bot.utils.mysql import db


@dp.message_handler(IsNotAdminUser(), Text('๐ ะกะพะฒะผะตััะธะผะพััั'))
async def compatibility_handler(message: types.Message):
    if not await check_subscribe_channels(message.from_user.id):
        with open('bot/images/compatibility.jpg', 'rb') as compatibility:
            await bot.send_photo(message.chat.id, compatibility, '๐ ะกะพะฒะผะตััะธะผะพััั\n\n'
                                                                 'ะะตะถะดั ___ ะธ ___\n\n'
                                                                 '๐ฒ ะัะฑะตัะธัะต ะดะฒะฐ ะทะฝะฐะบะฐ ะทะพะดะธะฐะบะฐ',
                                 reply_markup=await ikb.compatibility_keyboard())


@dp.callback_query_handler(IsNotAdminUser(), lambda callback: callback.data.startswith('comp_'))
async def compatibility_callback(callback: types.CallbackQuery, state: FSMContext):
    await callback.answer()
    first_sign = ''
    second_sign = ''
    sign = ''
    text_message = callback.message.caption
    message_callback = callback.data[5:]
    if message_callback == 'aries':
        sign = 'โ๏ธ ะะฒะตะฝ'
    elif message_callback == 'taurus':
        sign = 'โ๏ธ ะขะตะปะตั'
    elif message_callback == 'twins':
        sign = 'โ๏ธ ะะปะธะทะฝะตัั'
    elif message_callback == 'cancer':
        sign = 'โ๏ธ ะะฐะบ'
    elif message_callback == 'leo':
        sign = 'โ๏ธ ะะตะฒ'
    elif message_callback == 'maiden':
        sign = 'โ๏ธ ะะตะฒะฐ'
    elif message_callback == 'libra':
        sign = 'โ๏ธ ะะตัั'
    elif message_callback == 'scorpio':
        sign = 'โ๏ธ ะกะบะพัะฟะธะพะฝ'
    elif message_callback == 'sagittarius':
        sign = 'โ๏ธ ะกััะตะปะตั'
    elif message_callback == 'capricorn':
        sign = 'โ๏ธ ะะพะทะตัะพะณ'
    elif message_callback == 'aquarius':
        sign = 'โ๏ธ ะะพะดะพะปะตะน'
    elif message_callback == 'pisces':
        sign = 'โ๏ธ ะัะฑั'

    if '___ ะธ ___' in text_message:
        try:
            await bot.edit_message_caption(callback.message.chat.id, callback.message.message_id,
                                       caption='๐ ะกะพะฒะผะตััะธะผะพััั\n\n'
                                               f'ะะตะถะดั {sign} ะธ ___\n\n'
                                               '๐ฒ ะัะฑะตัะธัะต ะดะฒะฐ ะทะฝะฐะบะฐ ะทะพะดะธะฐะบะฐ',
                                       reply_markup=await ikb.compatibility_keyboard())
        except:
            pass
    else:
        middle_split = text_message.split('ะะตะถะดั ')[1]
        first_sign = (middle_split.split(' ะธ ___')[0]).strip()
        second_sign = sign

        compatibility = {
            "โ๏ธ ะะฒะตะฝ": {
                "โ๏ธ ะะฒะตะฝ": 1,
                "โ๏ธ ะขะตะปะตั": 2,
                "โ๏ธ ะะปะธะทะฝะตัั": 3,
                "โ๏ธ ะะฐะบ": 4,
                "โ๏ธ ะะตะฒ": 5,
                "โ๏ธ ะะตะฒะฐ": 6,
                "โ๏ธ ะะตัั": 7,
                "โ๏ธ ะกะบะพัะฟะธะพะฝ": 8,
                "โ๏ธ ะกััะตะปะตั": 9,
                "โ๏ธ ะะพะทะตัะพะณ": 10,
                "โ๏ธ ะะพะดะพะปะตะน": 11,
                "โ๏ธ ะัะฑั": 12,
            },
            "โ๏ธ ะขะตะปะตั": {
                "โ๏ธ ะะฒะตะฝ": 2,
                "โ๏ธ ะขะตะปะตั": 13,
                "โ๏ธ ะะปะธะทะฝะตัั": 14,
                "โ๏ธ ะะฐะบ": 15,
                "โ๏ธ ะะตะฒ": 16,
                "โ๏ธ ะะตะฒะฐ": 17,
                "โ๏ธ ะะตัั": 18,
                "โ๏ธ ะกะบะพัะฟะธะพะฝ": 19,
                "โ๏ธ ะกััะตะปะตั": 20,
                "โ๏ธ ะะพะทะตัะพะณ": 21,
                "โ๏ธ ะะพะดะพะปะตะน": 22,
                "โ๏ธ ะัะฑั": 23,
            },
            "โ๏ธ ะะปะธะทะฝะตัั": {
                "โ๏ธ ะะฒะตะฝ": 3,
                "โ๏ธ ะขะตะปะตั": 14,
                "โ๏ธ ะะปะธะทะฝะตัั": 24,
                "โ๏ธ ะะฐะบ": 25,
                "โ๏ธ ะะตะฒ": 26,
                "โ๏ธ ะะตะฒะฐ": 27,
                "โ๏ธ ะะตัั": 28,
                "โ๏ธ ะกะบะพัะฟะธะพะฝ": 29,
                "โ๏ธ ะกััะตะปะตั": 30,
                "โ๏ธ ะะพะทะตัะพะณ": 31,
                "โ๏ธ ะะพะดะพะปะตะน": 32,
                "โ๏ธ ะัะฑั": 33,
            },
            "โ๏ธ ะะฐะบ": {
                "โ๏ธ ะะฒะตะฝ": 4,
                "โ๏ธ ะขะตะปะตั": 15,
                "โ๏ธ ะะปะธะทะฝะตัั": 25,
                "โ๏ธ ะะฐะบ": 34,
                "โ๏ธ ะะตะฒ": 35,
                "โ๏ธ ะะตะฒะฐ": 36,
                "โ๏ธ ะะตัั": 37,
                "โ๏ธ ะกะบะพัะฟะธะพะฝ": 38,
                "โ๏ธ ะกััะตะปะตั": 39,
                "โ๏ธ ะะพะทะตัะพะณ": 40,
                "โ๏ธ ะะพะดะพะปะตะน": 41,
                "โ๏ธ ะัะฑั": 42,
            },
            "โ๏ธ ะะตะฒ": {
                "โ๏ธ ะะฒะตะฝ": 5,
                "โ๏ธ ะขะตะปะตั": 16,
                "โ๏ธ ะะปะธะทะฝะตัั": 26,
                "โ๏ธ ะะฐะบ": 35,
                "โ๏ธ ะะตะฒ": 43,
                "โ๏ธ ะะตะฒะฐ": 44,
                "โ๏ธ ะะตัั": 45,
                "โ๏ธ ะกะบะพัะฟะธะพะฝ": 46,
                "โ๏ธ ะกััะตะปะตั": 47,
                "โ๏ธ ะะพะทะตัะพะณ": 48,
                "โ๏ธ ะะพะดะพะปะตะน": 49,
                "โ๏ธ ะัะฑั": 50,
            },
            "โ๏ธ ะะตะฒะฐ": {
                "โ๏ธ ะะฒะตะฝ": 6,
                "โ๏ธ ะขะตะปะตั": 17,
                "โ๏ธ ะะปะธะทะฝะตัั": 27,
                "โ๏ธ ะะฐะบ": 36,
                "โ๏ธ ะะตะฒ": 44,
                "โ๏ธ ะะตะฒะฐ": 51,
                "โ๏ธ ะะตัั": 52,
                "โ๏ธ ะกะบะพัะฟะธะพะฝ": 53,
                "โ๏ธ ะกััะตะปะตั": 54,
                "โ๏ธ ะะพะทะตัะพะณ": 55,
                "โ๏ธ ะะพะดะพะปะตะน": 56,
                "โ๏ธ ะัะฑั": 57,
            },
            "โ๏ธ ะะตัั": {
                "โ๏ธ ะะฒะตะฝ": 7,
                "โ๏ธ ะขะตะปะตั": 18,
                "โ๏ธ ะะปะธะทะฝะตัั": 28,
                "โ๏ธ ะะฐะบ": 37,
                "โ๏ธ ะะตะฒ": 45,
                "โ๏ธ ะะตะฒะฐ": 52,
                "โ๏ธ ะะตัั": 58,
                "โ๏ธ ะกะบะพัะฟะธะพะฝ": 59,
                "โ๏ธ ะกััะตะปะตั": 60,
                "โ๏ธ ะะพะทะตัะพะณ": 61,
                "โ๏ธ ะะพะดะพะปะตะน": 62,
                "โ๏ธ ะัะฑั": 63,
            },
            "โ๏ธ ะกะบะพัะฟะธะพะฝ": {
                "โ๏ธ ะะฒะตะฝ": 8,
                "โ๏ธ ะขะตะปะตั": 19,
                "โ๏ธ ะะปะธะทะฝะตัั": 29,
                "โ๏ธ ะะฐะบ": 38,
                "โ๏ธ ะะตะฒ": 46,
                "โ๏ธ ะะตะฒะฐ": 53,
                "โ๏ธ ะะตัั": 59,
                "โ๏ธ ะกะบะพัะฟะธะพะฝ": 64,
                "โ๏ธ ะกััะตะปะตั": 65,
                "โ๏ธ ะะพะทะตัะพะณ": 66,
                "โ๏ธ ะะพะดะพะปะตะน": 67,
                "โ๏ธ ะัะฑั": 68,
            },
            "โ๏ธ ะกััะตะปะตั": {
                "โ๏ธ ะะฒะตะฝ": 9,
                "โ๏ธ ะขะตะปะตั": 20,
                "โ๏ธ ะะปะธะทะฝะตัั": 30,
                "โ๏ธ ะะฐะบ": 39,
                "โ๏ธ ะะตะฒ": 47,
                "โ๏ธ ะะตะฒะฐ": 54,
                "โ๏ธ ะะตัั": 60,
                "โ๏ธ ะกะบะพัะฟะธะพะฝ": 65,
                "โ๏ธ ะกััะตะปะตั": 69,
                "โ๏ธ ะะพะทะตัะพะณ": 70,
                "โ๏ธ ะะพะดะพะปะตะน": 71,
                "โ๏ธ ะัะฑั": 72,
            },
            "โ๏ธ ะะพะทะตัะพะณ": {
                "โ๏ธ ะะฒะตะฝ": 10,
                "โ๏ธ ะขะตะปะตั": 21,
                "โ๏ธ ะะปะธะทะฝะตัั": 31,
                "โ๏ธ ะะฐะบ": 40,
                "โ๏ธ ะะตะฒ": 48,
                "โ๏ธ ะะตะฒะฐ": 55,
                "โ๏ธ ะะตัั": 61,
                "โ๏ธ ะกะบะพัะฟะธะพะฝ": 66,
                "โ๏ธ ะกััะตะปะตั": 70,
                "โ๏ธ ะะพะทะตัะพะณ": 73,
                "โ๏ธ ะะพะดะพะปะตะน": 74,
                "โ๏ธ ะัะฑั": 75,
            },
            "โ๏ธ ะะพะดะพะปะตะน": {
                "โ๏ธ ะะฒะตะฝ": 11,
                "โ๏ธ ะขะตะปะตั": 22,
                "โ๏ธ ะะปะธะทะฝะตัั": 32,
                "โ๏ธ ะะฐะบ": 41,
                "โ๏ธ ะะตะฒ": 49,
                "โ๏ธ ะะตะฒะฐ": 56,
                "โ๏ธ ะะตัั": 62,
                "โ๏ธ ะกะบะพัะฟะธะพะฝ": 67,
                "โ๏ธ ะกััะตะปะตั": 71,
                "โ๏ธ ะะพะทะตัะพะณ": 74,
                "โ๏ธ ะะพะดะพะปะตะน": 76,
                "โ๏ธ ะัะฑั": 77,
            },
            "โ๏ธ ะัะฑั": {
                "โ๏ธ ะะฒะตะฝ": 12,
                "โ๏ธ ะขะตะปะตั": 23,
                "โ๏ธ ะะปะธะทะฝะตัั": 33,
                "โ๏ธ ะะฐะบ": 42,
                "โ๏ธ ะะตะฒ": 50,
                "โ๏ธ ะะตะฒะฐ": 57,
                "โ๏ธ ะะตัั": 63,
                "โ๏ธ ะกะบะพัะฟะธะพะฝ": 68,
                "โ๏ธ ะกััะตะปะตั": 72,
                "โ๏ธ ะะพะทะตัะพะณ": 75,
                "โ๏ธ ะะพะดะพะปะตะน": 77,
                "โ๏ธ ะัะฑั": 78,
            },
        }
        compatibility_number = compatibility[f'{first_sign}'][f'{second_sign}']
        compatibility_text = compatibility_caption[compatibility_number]
        try:
            await bot.edit_message_caption(callback.message.chat.id, callback.message.message_id,
                                       caption='๐ ะกะพะฒะผะตััะธะผะพััั\n\n'
                                               f'ะะตะถะดั {first_sign} ะธ {second_sign}\n\n'
                                               f'๐ฒ ะัะฑะตัะธัะต ะดะฒะฐ ะทะฝะฐะบะฐ ะทะพะดะธะฐะบะฐ\n\n{compatibility_text}')
        except:
            pass
